name: Build & Deploy Static Frontend (Safe Deploy)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build_and_deploy:
    runs-on: self-hosted
    env:
      VITE_FIREBASE_SHIT: ${{ secrets.VITE_FIREBASE_SHIT }}
    defaults:
      run:
        working-directory: Frontend

    steps:
      # 1ï¸âƒ£ Checkout latest code (force clean pull)
      - name: Checkout latest repository code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0          # fetch full commit history
          clean: true             # remove old workspace files
          ref: main               # ensure correct branch

      # 2ï¸âƒ£ Ensure the repo is truly up to date (double-safe)
      - name: Force update repository
        run: |
          git fetch origin main
          git reset --hard origin/main
          echo "âœ… Repository now at latest commit:"
          git log -1 --oneline

      # 3ï¸âƒ£ Verify Docker and Compose versions
      - name: Docker environment
        run: |
          docker version
          docker compose version

      # 4ï¸âƒ£ Clean old Docker images (optional but ensures no cache)
      - name: Clean old Docker images
        run: |
          echo "ğŸ§¹ Cleaning up old Docker images..."
          docker image prune -a -f || true
          echo "âœ… Old images removed."

      # 5ï¸âƒ£ Build Docker image (force fresh build)
      - name: Build Docker image (no cache)
        run: |
          echo "ğŸ› ï¸ Building Docker image from latest source..."
          docker compose build --no-cache --progress=plain --build-arg VITE_FIREBASE_SHIT="${VITE_FIREBASE_SHIT}"
          echo "âœ… Fresh Docker build completed."

      # 6ï¸âƒ£ Test built image (verify Nginx syntax)
      - name: Test build success
        run: |
          echo "ğŸ§ª Running container test..."
          docker run --rm nodpt-frontend:latest nginx -t || (echo "âŒ Nginx test failed" && exit 1)
          echo "âœ… Nginx syntax OK."

      # 7ï¸âƒ£ Stop current running containers safely
      - name: Stop current deployment
        run: |
          echo "ğŸ›‘ Stopping existing deployment..."
          docker compose down || true
          echo "âœ… Old containers stopped."

      # 8ï¸âƒ£ Start new deployment (with latest build)
      - name: Deploy new version
        run: |
          echo "ğŸš€ Starting new deployment..."
          docker compose up -d --build
          echo "âœ… Deployment started."

      # 9ï¸âƒ£ Verify running containers
      - name: Check running containers
        run: |
          echo "ğŸ“‹ Active containers:"
          docker ps

      # ğŸ”Ÿ Health check after deployment
      - name: Health check
        run: |
          echo "âŒ› Waiting for service to start..."
          sleep 5
          echo "ğŸŒ Performing health check on localhost:8443"
          curl -I http://localhost:8443 || (echo "âŒ Health check failed" && exit 1)
          echo "âœ… Health check passed."
