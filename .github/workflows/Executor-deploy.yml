name: Executor Build and Deploy (Self-Hosted)

on:
   push:
      branches: [main, master]
      paths:
         - 'Executor/**'

jobs:
   build-and-deploy:
      runs-on: self-hosted
      permissions:
         contents: read

      steps:
         # 1Ô∏è‚É£ Checkout repository
         - name: 1. Checkout repository
           uses: actions/checkout@v4

         # 2Ô∏è‚É£ Verify directory layout
         - name: 2. Verify directory layout
           working-directory: .
           run: |
              echo "Workspace content:"
              pwd
              ls
              echo ""
              echo "Executor contents:"
              ls Executor/src
              echo ""
              echo "Data contents:"
              ls Data/src
              test -f Executor/src/BackendExecutor.csproj
              test -f Data/src/NodPT.Data.csproj

         # 3Ô∏è‚É£ Setup Docker Buildx
         - name: 3. Set up Docker Buildx
           uses: docker/setup-buildx-action@v3

         # 4Ô∏è‚É£ Pull latest .NET base images
         - name: 4. Pull latest .NET base images
           run: |
              docker pull mcr.microsoft.com/dotnet/sdk:8.0
              docker pull mcr.microsoft.com/dotnet/aspnet:8.0

         # 5Ô∏è‚É£ Build Docker image
         - name: 5. Build Docker image
           working-directory: Executor
           run: |
              docker compose build --pull --no-cache

         # 6Ô∏è‚É£ Remove old container (required because container_name is fixed)
         - name: 6. Remove old container
           working-directory: Executor
           run: |
              docker rm -f nodpt-executor || true

         # 7Ô∏è‚É£ Stop current deployment
         - name: 7. Stop current deployment
           working-directory: Executor
           run: |
              docker compose down || true

         # 8Ô∏è‚É£ Deploy new version
         - name: 8. Deploy new version
           working-directory: Executor
           run: |
              docker compose up -d --build --pull always

         # 9Ô∏è‚É£ Verify deployment
         - name: 9. Verify deployment
           working-directory: Executor
           run: |
              echo "Checking if Executor container is running..."
              sleep 5
              if docker ps --filter "name=nodpt-executor" --filter "status=running" | grep -q nodpt-executor; then
                echo "Executor container is running"
                docker ps --filter "name=nodpt-executor"
                exit 0
              else
                echo "Executor container is not running"
                docker compose logs
                exit 1
              fi

         # üîü Verify Ollama endpoint connectivity
         - name: 10. Verify Ollama endpoint
           run: |
              echo "=== Verifying Ollama Endpoint Connectivity ==="
              echo "Testing endpoint: http://ollama:11434/api/generate"
              
              # Retry up to 3 times with 5 second delays
              MAX_RETRIES=3
              RETRY_DELAY=5
              
              for attempt in $(seq 1 $MAX_RETRIES); do
                echo "Attempt $attempt of $MAX_RETRIES..."
                
                # Test Ollama endpoint with a simple request
                if docker exec nodpt-executor curl -s --max-time 30 -X POST http://ollama:11434/api/generate \
                  -H "Content-Type: application/json" \
                  -d '{"model":"llama3.2:3b","prompt":"Hello","stream":false,"options":{"num_predict":10,"temperature":0.7}}' \
                  | grep -q "response"; then
                  
                  echo "‚úÖ Ollama endpoint verification successful!"
                  echo "Executor can successfully communicate with Ollama"
                  exit 0
                else
                  echo "‚ö†Ô∏è  Ollama verification attempt $attempt failed"
                  
                  if [ $attempt -lt $MAX_RETRIES ]; then
                    echo "Retrying in $RETRY_DELAY seconds..."
                    sleep $RETRY_DELAY
                  fi
                fi
              done
              
              echo "‚ùå Ollama verification failed after $MAX_RETRIES attempts"
              echo "Please check:"
              echo "  1. Ollama container is running (docker ps | grep ollama)"
              echo "  2. Ollama is accessible on the network (docker exec nodpt-executor curl http://ollama:11434/api/tags)"
              echo "  3. Ollama has OLLAMA_HOST=0.0.0.0:11434 environment variable set"
              echo "  4. Ollama has OLLAMA_ORIGINS=* environment variable set"
              echo "  5. The model 'llama3.2:3b' is available (docker exec ollama ollama list)"
              exit 1

         # 1Ô∏è‚É£1Ô∏è‚É£ Show logs on failure
         - name: 11. Show logs on failure
           if: failure()
           working-directory: Executor
           run: docker compose logs
