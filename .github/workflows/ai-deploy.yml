name: AI Build and Deploy (Self-Hosted)

on:
   push:
      branches: [main, master]
      paths:
         - 'AI/**'

jobs:
   build-and-deploy:
      runs-on: self-hosted
      permissions:
         contents: read

      steps:
         # 1Ô∏è‚É£ Checkout repository
         - name: 1. Checkout repository
           uses: actions/checkout@v4

         # 2Ô∏è‚É£ Verify directory layout
         - name: 2. Verify directory layout
           working-directory: .
           run: |
              echo "Workspace content:"
              pwd
              ls
              echo ""
              echo "AI contents:"
              ls AI/src
              test -f AI/Dockerfile
              test -f AI/docker-compose.yml
              test -f AI/src/main.py

         # 3Ô∏è‚É£ Setup Docker Buildx
         - name: 3. Set up Docker Buildx
           uses: docker/setup-buildx-action@v3

         # 4Ô∏è‚É£ Verify NVIDIA GPU and Docker runtime
         - name: 4. Verify NVIDIA GPU support
           run: |
              echo "Checking NVIDIA GPU availability..."
              nvidia-smi || echo "Warning: nvidia-smi not found"
              echo ""
              echo "Checking NVIDIA Docker runtime..."
              docker run --rm --gpus all nvidia/cuda:12.1.0-base-ubuntu22.04 nvidia-smi || echo "Warning: NVIDIA Docker runtime not available"

         # 5Ô∏è‚É£ Pull base CUDA image
         - name: 5. Pull base CUDA image
           run: |
              docker pull nvidia/cuda:12.1.0-devel-ubuntu22.04

         # 6Ô∏è‚É£ Build Docker image
         - name: 6. Build Docker image
           working-directory: AI
           run: |
              docker compose build --pull --no-cache

         # 7Ô∏è‚É£ Remove old container (required because container_name is fixed)
         - name: 7. Remove old container
           working-directory: AI
           run: |
              docker rm -f nodpt-ai || true

         # 8Ô∏è‚É£ Stop current deployment
         - name: 8. Stop current deployment
           working-directory: AI
           run: |
              docker compose down || true

         # 9Ô∏è‚É£ Deploy new version
         - name: 9. Deploy new version
           working-directory: AI
           run: |
              docker compose up -d --build

         # üîü Wait for service to start
         - name: 10. Wait for service startup
           run: |
              echo "Waiting for AI service to start..."
              sleep 10

         # 1Ô∏è‚É£1Ô∏è‚É£ Verify deployment health
         - name: 11. Verify deployment health
           working-directory: AI
           run: |
              echo "Checking AI service health endpoint..."
              for i in {1..5}; do
                if curl -fsS http://localhost:8850/health > /dev/null; then
                  echo "AI service is healthy"
                  echo "Service info:"
                  curl -s http://localhost:8850/info | python3 -m json.tool || true
                  exit 0
                fi
                echo "Attempt $i/5 failed, retrying..."
                sleep 5
              done
              echo "Service failed health check"
              docker compose logs
              exit 1

         # 1Ô∏è‚É£2Ô∏è‚É£ Show running containers
         - name: 12. Show running containers
           run: |
              echo "Active containers:"
              docker ps | grep nodpt-ai || docker ps

         # 1Ô∏è‚É£3Ô∏è‚É£ Show logs on failure
         - name: 13. Show logs on failure
           if: failure()
           working-directory: AI
           run: docker compose logs
